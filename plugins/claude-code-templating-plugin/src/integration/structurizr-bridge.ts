/**
 * Structurizr Integration Bridge
 *
 * Connects archetype scaffolding with Structurizr architecture documentation.
 * Automatically generates and registers architecture fragments when new projects
 * are scaffolded from archetypes.
 */

import { readFile, writeFile, mkdir } from 'fs/promises';
import { join, dirname } from 'path';
import type { TemplateVariable } from '../types/scaffold.js';

// ============================================================================
// TYPES
// ============================================================================

export interface StructurizrConfig {
  workspacePath: string;
  fragmentsPath: string;
  autoRegister: boolean;
  exportFormats: string[];
  githubPagesRepo?: string;
}

export interface ArchitectureMetadata {
  name: string;
  description: string;
  type: 'softwareSystem' | 'container' | 'component';
  technology: string;
  tags: string[];
  containers?: ContainerMetadata[];
  relationships?: RelationshipMetadata[];
}

export interface ContainerMetadata {
  name: string;
  description: string;
  technology: string;
  type: 'API' | 'Database' | 'WebApp' | 'Queue' | 'Cache';
}

export interface RelationshipMetadata {
  from?: string; // If not specified, uses the system itself
  to: string;
  description: string;
  technology?: string;
}

export interface ProjectVariables {
  project_name: string;
  project_description?: string;
  database_type?: string;
  include_auth?: boolean;
  include_events?: boolean;
  technology?: string;
  [key: string]: unknown;
}

// ============================================================================
// DSL GENERATOR
// ============================================================================

/**
 * Generate Structurizr DSL fragment from project variables and metadata
 */
export function generateDslFragment(
  variables: ProjectVariables,
  metadata: ArchitectureMetadata
): string {
  const name = variables.project_name;
  const camelName = toCamelCase(name);
  const titleName = toTitleCase(name);
  const description = variables.project_description || metadata.description;

  let dsl = `# ===== SERVICE: ${name} =====\n`;
  dsl += `# Generated by Archetype-Structurizr Bridge\n`;
  dsl += `# Date: ${new Date().toISOString()}\n\n`;

  // Software System definition
  dsl += `${camelName} = softwareSystem "${titleName}" "${description}" {\n`;
  dsl += `    tags "${metadata.tags.join('" "')}"\n\n`;

  // Generate containers
  if (metadata.containers) {
    for (const container of metadata.containers) {
      const containerCamel = toCamelCase(container.name);
      dsl += `    ${camelName}${containerCamel} = container "${container.name}" "${container.description}" "${container.technology}" {\n`;
      dsl += `        tags "${container.type}"\n`;
      dsl += `    }\n\n`;
    }

    // Internal relationships between containers
    const apiContainer = metadata.containers.find(c => c.type === 'API');
    const dbContainer = metadata.containers.find(c => c.type === 'Database');

    if (apiContainer && dbContainer) {
      const apiCamel = toCamelCase(apiContainer.name);
      const dbCamel = toCamelCase(dbContainer.name);
      dsl += `    ${camelName}${apiCamel} -> ${camelName}${dbCamel} "Reads/Writes" "${getDatabaseProtocol(variables.database_type)}"\n`;
    }
  }

  dsl += `}\n\n`;

  // External relationships
  dsl += `# Relationships\n`;

  // Auth relationship
  if (variables.include_auth) {
    dsl += `${camelName} -> keycloak "Validates tokens" "OAuth2/OIDC"\n`;
  }

  // Database relationship (to external managed service)
  if (variables.database_type) {
    const dbTarget = getDatabaseTarget(variables.database_type);
    dsl += `${camelName} -> ${dbTarget} "Stores data" "${getDatabaseProtocol(variables.database_type)}"\n`;
  }

  // Standard relationships
  dsl += `uiSite -> ${camelName} "Uses" "REST/HTTPS"\n`;
  dsl += `gateway -> ${camelName} "Routes to"\n`;

  // Custom relationships from metadata
  if (metadata.relationships) {
    for (const rel of metadata.relationships) {
      const from = rel.from || camelName;
      dsl += `${from} -> ${rel.to} "${rel.description}"`;
      if (rel.technology) {
        dsl += ` "${rel.technology}"`;
      }
      dsl += `\n`;
    }
  }

  return dsl;
}

/**
 * Generate Structurizr fragment template (with template variables)
 */
export function generateFragmentTemplate(
  templateVariables: TemplateVariable[]
): string {
  let template = `# ===== SERVICE: {{ project_name }} =====\n`;
  template += `# Structurizr Fragment Template\n`;
  template += `# Variables: ${templateVariables.map(v => v.name).join(', ')}\n\n`;

  template += `{{ project_name | camelCase }} = softwareSystem "{{ project_name | titleCase }}" "{{ project_description }}" {\n`;
  template += `    tags "Internal" "Backend" "Microservice"\n\n`;

  // API Container
  template += `    {{ project_name | camelCase }}Api = container "{{ project_name | titleCase }} API" "{{ project_description }}" "{{ technology | default('Python, FastAPI') }}" {\n`;
  template += `        tags "API"\n`;
  template += `    }\n\n`;

  // Database Container (conditional)
  template += `    {% if database_type %}\n`;
  template += `    {{ project_name | camelCase }}Db = container "{{ project_name | titleCase }} Database" "Data store" "{{ database_type | titleCase }}" {\n`;
  template += `        tags "Database"\n`;
  template += `    }\n`;
  template += `    {{ project_name | camelCase }}Api -> {{ project_name | camelCase }}Db "Reads/Writes"\n`;
  template += `    {% endif %}\n\n`;

  // Auth relationship (conditional)
  template += `    {% if include_auth %}\n`;
  template += `    {{ project_name | camelCase }}Api -> keycloak "Validates tokens" "OAuth2/OIDC"\n`;
  template += `    {% endif %}\n`;

  template += `}\n\n`;

  // Standard relationships
  template += `# Relationships\n`;
  template += `uiSite -> {{ project_name | camelCase }} "Uses" "REST/HTTPS"\n`;
  template += `gateway -> {{ project_name | camelCase }} "Routes to"\n`;

  return template;
}

// ============================================================================
// WORKSPACE OPERATIONS
// ============================================================================

/**
 * Register a new service in the Structurizr workspace
 */
export async function registerInWorkspace(
  config: StructurizrConfig,
  variables: ProjectVariables,
  metadata: ArchitectureMetadata
): Promise<void> {
  // Generate fragment
  const fragment = generateDslFragment(variables, metadata);

  // Save fragment to fragments directory
  const fragmentPath = join(config.fragmentsPath, `${variables.project_name}.dsl`);
  await mkdir(dirname(fragmentPath), { recursive: true });
  await writeFile(fragmentPath, fragment, 'utf-8');

  // Append to workspace if auto-register enabled
  if (config.autoRegister) {
    const workspace = await readFile(config.workspacePath, 'utf-8');

    // Find the model closing brace and insert before it
    const modelEndIndex = workspace.lastIndexOf('}');
    if (modelEndIndex > 0) {
      const updatedWorkspace =
        workspace.slice(0, modelEndIndex) +
        '\n\n        # Auto-registered by Archetype Bridge\n' +
        fragment.split('\n').map(line => '        ' + line).join('\n') +
        '\n' +
        workspace.slice(modelEndIndex);

      await writeFile(config.workspacePath, updatedWorkspace, 'utf-8');
    }
  }
}

/**
 * Validate workspace DSL syntax
 */
export async function validateWorkspace(workspacePath: string): Promise<boolean> {
  const { exec } = await import('child_process');
  const { promisify } = await import('util');
  const execAsync = promisify(exec);

  try {
    await execAsync(`structurizr-cli validate -workspace "${workspacePath}"`);
    return true;
  } catch {
    return false;
  }
}

/**
 * Export diagrams from workspace
 */
export async function exportDiagrams(
  config: StructurizrConfig,
  outputDir: string
): Promise<string[]> {
  const { exec } = await import('child_process');
  const { promisify } = await import('util');
  const execAsync = promisify(exec);

  const exportedFiles: string[] = [];

  for (const format of config.exportFormats) {
    const formatDir = join(outputDir, format);
    await mkdir(formatDir, { recursive: true });

    await execAsync(
      `structurizr-cli export -workspace "${config.workspacePath}" -format ${format} -output "${formatDir}"`
    );

    exportedFiles.push(formatDir);
  }

  return exportedFiles;
}

// ============================================================================
// HARNESS INTEGRATION
// ============================================================================

export interface HarnessTemplateConfig {
  org: string;
  project: string;
  accountId: string;
}

/**
 * Generate Harness pipeline template that includes Structurizr update steps
 */
export function generateHarnessPipelineWithArchitecture(
  projectName: string,
  structurizrConfig: StructurizrConfig
): string {
  return `
pipeline:
  name: ${projectName}-ci-cd
  identifier: ${projectName.replace(/-/g, '_')}_ci_cd
  projectIdentifier: thelobbi
  orgIdentifier: default

  stages:
    # Standard CI stages...
    - stage:
        name: Build
        identifier: build
        type: CI
        spec:
          cloneCodebase: true
          execution:
            steps:
              - step:
                  type: Run
                  name: Build
                  spec:
                    shell: Bash
                    command: |
                      # Build commands here

    - stage:
        name: Test
        identifier: test
        type: CI
        spec:
          execution:
            steps:
              - step:
                  type: Run
                  name: Test
                  spec:
                    shell: Bash
                    command: |
                      # Test commands here

    # Architecture Update Stage
    - stage:
        name: Update Architecture
        identifier: update_architecture
        type: CI
        when:
          condition: <+codebase.branch> == "main"
        spec:
          execution:
            steps:
              - step:
                  type: Run
                  name: Validate Structurizr
                  identifier: validate_structurizr
                  spec:
                    shell: Bash
                    command: |
                      structurizr-cli validate \\
                        -workspace ${structurizrConfig.workspacePath}

              - step:
                  type: Run
                  name: Export Diagrams
                  identifier: export_diagrams
                  spec:
                    shell: Bash
                    command: |
                      ${structurizrConfig.exportFormats.map(f =>
                        `structurizr-cli export -workspace ${structurizrConfig.workspacePath} -format ${f} -output docs/diagrams/${f}/`
                      ).join('\n                      ')}

              - step:
                  type: Run
                  name: Push to GitHub Pages
                  identifier: push_pages
                  spec:
                    shell: Bash
                    command: |
                      git config user.name "Harness CI"
                      git config user.email "ci@harness.io"

                      # Checkout gh-pages
                      git checkout gh-pages || git checkout --orphan gh-pages

                      # Copy diagrams
                      cp -r docs/diagrams/* .

                      # Commit and push
                      git add .
                      git commit -m "Update architecture diagrams - Build <+pipeline.sequenceId>" || true
                      git push origin gh-pages --force

    # Deployment stages...
    - stage:
        name: Deploy
        identifier: deploy
        type: Deployment
        # ...
`;
}

// ============================================================================
// UTILITIES
// ============================================================================

function toCamelCase(str: string): string {
  return str
    .replace(/[-_](.)/g, (_, c) => c.toUpperCase())
    .replace(/^(.)/, (_, c) => c.toLowerCase());
}

function toTitleCase(str: string): string {
  return str
    .replace(/[-_]/g, ' ')
    .replace(/\b\w/g, c => c.toUpperCase());
}

function getDatabaseTarget(dbType?: string): string {
  switch (dbType?.toLowerCase()) {
    case 'mongodb':
      return 'mongoAtlas';
    case 'postgresql':
    case 'postgres':
      return 'rds';
    case 'mysql':
      return 'rds';
    case 'redis':
      return 'elasticache';
    default:
      return 'database';
  }
}

function getDatabaseProtocol(dbType?: string): string {
  switch (dbType?.toLowerCase()) {
    case 'mongodb':
      return 'MongoDB Wire Protocol';
    case 'postgresql':
    case 'postgres':
      return 'SQL/TLS';
    case 'mysql':
      return 'SQL/TLS';
    case 'redis':
      return 'Redis Protocol';
    default:
      return 'Database Protocol';
  }
}

// ============================================================================
// EXPORTS
// ============================================================================

export const StructurizrBridge = {
  generateDslFragment,
  generateFragmentTemplate,
  registerInWorkspace,
  validateWorkspace,
  exportDiagrams,
  generateHarnessPipelineWithArchitecture
};

export default StructurizrBridge;
