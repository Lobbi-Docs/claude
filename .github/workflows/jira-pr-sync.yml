name: Jira PR Sync

# Purpose: Automatically sync GitHub Pull Request lifecycle events with Jira issues
# Benefits: Keeps Jira issues updated with PR status, reduces manual status updates
# Triggers: PR opened, updated, merged, or closed
# Security: Uses repository secrets for Jira authentication

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  pull-requests: read
  contents: read

jobs:
  sync-pr-to-jira:
    name: Sync PR Status to Jira
    runs-on: ubuntu-latest

    # Skip if PR is from Dependabot or other bots (optional)
    if: github.actor != 'dependabot[bot]'

    steps:
      # Step 1: Checkout repository to access commit history
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history to extract all commit messages

      # Step 2: Authenticate with Jira
      # Required secrets: JIRA_BASE_URL, JIRA_USER_EMAIL, JIRA_API_TOKEN
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # Step 3: Extract Jira issue key from PR branch name or title
      # Looks for patterns like: PROJECT-123, TEAM-456
      # Branch examples: feature/PROJECT-123-description, bugfix/TEAM-456
      - name: Find Jira issue key
        id: find-issue
        uses: atlassian/gajira-find-issue-key@v3
        with:
          # Search in branch name first, then PR title
          from: branch,title
        continue-on-error: true

      # Step 4: Post PR link as comment on Jira issue
      # Only runs if issue key was found
      - name: Comment PR link on Jira
        if: steps.find-issue.outputs.issue != ''
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ steps.find-issue.outputs.issue }}
          comment: |
            :rocket: **Pull Request Update**

            **PR:** [#${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})
            **Author:** @${{ github.event.pull_request.user.login }}
            **Status:** ${{ github.event.pull_request.state }}
            **Action:** ${{ github.event.action }}
            **Branch:** `${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`

            ${{ github.event.pull_request.mergeable == false && ':warning: **Merge conflicts detected**' || '' }}
            ${{ github.event.pull_request.draft == true && ':construction: **Draft PR**' || '' }}

      # Step 5: Transition issue when PR is opened or reopened
      # Moves issue to "In Review" status
      - name: Transition to In Review
        if: |
          steps.find-issue.outputs.issue != '' &&
          (github.event.action == 'opened' || github.event.action == 'reopened')
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.find-issue.outputs.issue }}
          transition: "In Review"
        continue-on-error: true  # Don't fail if transition doesn't exist

      # Step 6: Transition issue when PR is merged
      # Moves issue to "Done" status
      - name: Transition to Done (PR Merged)
        if: |
          steps.find-issue.outputs.issue != '' &&
          github.event.action == 'closed' &&
          github.event.pull_request.merged == true
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.find-issue.outputs.issue }}
          transition: "Done"
        continue-on-error: true

      # Step 7: Transition issue when PR is closed without merge
      # Returns issue to development status
      - name: Transition to Reopened (PR Closed Without Merge)
        if: |
          steps.find-issue.outputs.issue != '' &&
          github.event.action == 'closed' &&
          github.event.pull_request.merged == false
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.find-issue.outputs.issue }}
          transition: "Reopened"
        continue-on-error: true

      # Step 8: Handle multiple issue keys in commits
      # Extracts all Jira issue keys from commit messages in this PR
      - name: Extract issue keys from commits
        if: github.event.action == 'opened' || github.event.action == 'synchronize'
        id: extract-issues
        run: |
          # Get all commits in this PR
          git log --format=%s ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} > commits.txt

          # Extract unique Jira issue keys (format: PROJECT-123)
          grep -oE '[A-Z]{2,10}-[0-9]+' commits.txt | sort -u > issue_keys.txt || true

          # Output for debugging
          echo "Found issue keys:"
          cat issue_keys.txt || echo "No issue keys found"

          # Store as output (newline-separated list)
          ISSUE_KEYS=$(cat issue_keys.txt | tr '\n' ',' | sed 's/,$//')
          echo "issue_keys=$ISSUE_KEYS" >> $GITHUB_OUTPUT

      # Step 9: Comment on all related issues
      # Links all Jira issues mentioned in commits to this PR
      - name: Link all related Jira issues
        if: steps.extract-issues.outputs.issue_keys != ''
        run: |
          IFS=',' read -ra KEYS <<< "${{ steps.extract-issues.outputs.issue_keys }}"
          for KEY in "${KEYS[@]}"; do
            echo "Linking issue: $KEY"
            # Use Jira API directly for bulk operations
            curl -X POST \
              -H "Authorization: Basic $(echo -n ${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }} | base64)" \
              -H "Content-Type: application/json" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/$KEY/comment" \
              -d "{\"body\": {\"type\": \"doc\", \"version\": 1, \"content\": [{\"type\": \"paragraph\", \"content\": [{\"type\": \"text\", \"text\": \"ðŸ”— Related PR: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}\", \"marks\": [{\"type\": \"strong\"}]}, {\"type\": \"text\", \"text\": \"\n\"}, {\"type\": \"text\", \"text\": \"Link: ${{ github.event.pull_request.html_url }}\"}]}]}}" \
              || echo "Failed to comment on $KEY"
          done

      # Step 10: Notify on errors
      - name: Report sync status
        if: failure()
        run: |
          echo "::warning::Failed to sync PR with Jira. Check secrets configuration."
          echo "::warning::Required secrets: JIRA_BASE_URL, JIRA_USER_EMAIL, JIRA_API_TOKEN"

    # Prevent workflow from running longer than 5 minutes
    timeout-minutes: 5
